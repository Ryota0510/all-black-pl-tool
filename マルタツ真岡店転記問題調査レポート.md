# マルタツ真岡店データ転記問題 - 原因調査レポート

## 問題概要
- **症状**: マルタツ真岡店のみ売上報告データが転記されない
- **影響範囲**: マルタツ真岡店のみ（他の全店舗は正常動作）
- **発生タイミング**: 担当者に関係なく常時発生

## 調査結果

### 根本原因
`売上報告転記.js` の `extractDateFromLine` 関数における正規表現の不備

### 問題箇所
**ファイル**: `売上報告転記.js` (264行目)
```javascript
function extractDateFromLine(line) {
  // 時刻とユーザー名を削除
  line = line.replace(/^\d{2}:\d{2}\s+[^\s]+\s+/, ''); // ← この行が問題
  // ...
}
```

### 問題の詳細
1. **正規表現パターンの不備**
   - `\s` は半角スペースのみにマッチ（全角スペース `　` を認識しない）
   - `[^\s]+\s+` パターンが全角スペースを含むユーザー名を正しく処理できない

2. **実際のデータ例**
   ```
   マルタツ真岡店: "10:08 八谷　正夫 【日時】8月 9日(土) 【店舗名】マルタツ真岡店"
   他店舗例: "10:15 田中太郎 【日時】8月 9日(土) 【店舗名】○○店"
   ```

3. **処理の流れと失敗点**
   ```javascript
   // 期待される処理
   "10:08 八谷　正夫 【日時】8月 9日(土)" 
   → "【日時】8月 9日(土)" (時刻・ユーザー名削除)
   → "8月 9日" (日付抽出成功)
   
   // 実際の処理（失敗）
   "10:08 八谷　正夫 【日時】8月 9日(土)"
   → "　正夫 【日時】8月 9日(土)" (全角スペース以降が残る)
   → 日付抽出失敗 → ブロック作成失敗
   ```

## 影響範囲の分析

### なぜマルタツ真岡店のみ影響するか
- 担当者名に**全角スペース**を含むデータがマルタツ真岡店のみ
- 他店舗の担当者名は半角スペースまたはスペースなしのため問題なし

### データ転記プロセスへの影響
1. **parseReportDataFromB関数** (174行目)
   - 日付抽出失敗 → `currentBlock.date` が空文字
   - 183行目の条件 `currentBlock.date && currentBlock.store` が `false`
   - ブロックが配列に追加されない
   - 結果: マルタツ真岡店のデータが処理対象から除外

## 修正案

### 解決方法1: 正規表現の改良
```javascript
// 現在（問題あり）
line = line.replace(/^\d{2}:\d{2}\s+[^\s]+\s+/, '');

// 修正案1: 全角・半角スペース対応
line = line.replace(/^\d{2}:\d{2}[\s　]+[^\s　]*[\s　]*[^\s　]*[\s　]+/, '');
```

### 解決方法2: より確実なアプローチ
```javascript
// 修正案2: 【日時】までを直接削除
line = line.replace(/^.*?【日時】/, '【日時】');
```

## 検証方法

### テストケース
1. **成功例**: `"10:15 田中太郎 【日時】8月 9日(土)"` → `"2024/08/09"`
2. **失敗例**: `"10:08 八谷　正夫 【日時】8月 9日(土)"` → `""`（空文字）
3. **修正後**: `"10:08 八谷　正夫 【日時】8月 9日(土)"` → `"2024/08/09"`

### 動作確認
- GASエディタで `transferReportToMaster(true)` を実行
- マルタツ真岡店データが処理対象に含まれることを確認

## 推奨対応

1. **修正案2**を採用（より確実で保守しやすい）
2. 修正後の回帰テスト実施
3. 全店舗での動作確認

---
**調査日**: 2024年8月28日  
**調査者**: Claude Code